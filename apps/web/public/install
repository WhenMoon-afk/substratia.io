#!/bin/bash
# Substratia CLI Installer
# https://substratia.io
#
# Usage: curl -fsSL https://substratia.io/install | bash

set -e

REPO="WhenMoon-afk/substratia.io"  # GitHub repo (unused, kept for future binary releases)
INSTALL_DIR="${SUBSTRATIA_INSTALL_DIR:-$HOME/.substratia}"
BIN_DIR="${SUBSTRATIA_BIN_DIR:-$INSTALL_DIR/bin}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${CYAN}"
echo "  ____        _         _             _   _       "
echo " / ___| _   _| |__  ___| |_ _ __ __ _| |_(_) __ _ "
echo " \\___ \\| | | | '_ \\/ __| __| '__/ _\` | __| |/ _\` |"
echo "  ___) | |_| | |_) \\__ \\ |_| | | (_| | |_| | (_| |"
echo " |____/ \\__,_|_.__/|___/\\__|_|  \\__,_|\\__|_|\\__,_|"
echo -e "${NC}"
echo "Persistence for AI Agents"
echo ""

# Check for required tools
check_requirements() {
    local missing=()

    if ! command -v curl &> /dev/null && ! command -v wget &> /dev/null; then
        missing+=("curl or wget")
    fi

    if [ ${#missing[@]} -ne 0 ]; then
        echo -e "${RED}Error: Missing required tools: ${missing[*]}${NC}"
        exit 1
    fi
}

# Detect OS and architecture
detect_platform() {
    OS="$(uname -s)"
    ARCH="$(uname -m)"

    case "$OS" in
        Linux*)     OS="linux" ;;
        Darwin*)    OS="darwin" ;;
        MINGW*|MSYS*|CYGWIN*) OS="windows" ;;
        *)          echo -e "${RED}Unsupported OS: $OS${NC}"; exit 1 ;;
    esac

    case "$ARCH" in
        x86_64|amd64)   ARCH="x64" ;;
        arm64|aarch64)  ARCH="arm64" ;;
        *)              echo -e "${RED}Unsupported architecture: $ARCH${NC}"; exit 1 ;;
    esac

    PLATFORM="${OS}-${ARCH}"
    echo -e "Detected platform: ${GREEN}${PLATFORM}${NC}"
}

# Check if Bun is installed (preferred)
check_bun() {
    if command -v bun &> /dev/null; then
        echo -e "${GREEN}✓${NC} Bun is installed"
        return 0
    else
        return 1
    fi
}

# Check if Node.js is installed (fallback)
check_node() {
    if command -v node &> /dev/null; then
        NODE_VERSION=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)
        if [ "$NODE_VERSION" -ge 18 ]; then
            echo -e "${GREEN}✓${NC} Node.js $(node -v) is installed"
            return 0
        else
            echo -e "${RED}Node.js 18+ required, found $(node -v)${NC}"
            return 1
        fi
    else
        return 1
    fi
}

# Install via npm/bun (the simple path)
install_via_package_manager() {
    echo ""
    echo "Installing Substratia CLI..."
    echo ""

    if check_bun; then
        echo "Using Bun..."
        bun install -g @substratia/cli 2>/dev/null || {
            echo -e "${CYAN}Note: Global package not yet published. Using npx method.${NC}"
            install_wrapper_script
        }
    elif check_node; then
        echo "Using npm..."
        npm install -g @substratia/cli 2>/dev/null || {
            echo -e "${CYAN}Note: Global package not yet published. Using npx method.${NC}"
            install_wrapper_script
        }
    else
        echo -e "${RED}Error: Neither Bun nor Node.js 18+ is installed.${NC}"
        echo ""
        echo "Please install one of:"
        echo "  - Bun:     curl -fsSL https://bun.sh/install | bash"
        echo "  - Node.js: https://nodejs.org (v18 or later)"
        echo ""
        exit 1
    fi
}

# Install a wrapper script that uses npx
install_wrapper_script() {
    echo ""
    echo "Creating wrapper script..."

    mkdir -p "$BIN_DIR"

    cat > "$BIN_DIR/substratia" << 'WRAPPER'
#!/bin/bash
# Substratia CLI wrapper
# Runs the CLI via npx to always get the latest version

if command -v bunx &> /dev/null; then
    exec bunx @substratia/cli "$@"
elif command -v npx &> /dev/null; then
    exec npx @substratia/cli "$@"
else
    echo "Error: Neither bunx nor npx found. Please install Bun or Node.js."
    exit 1
fi
WRAPPER

    chmod +x "$BIN_DIR/substratia"

    # Add to PATH instructions
    add_to_path
}

# Provide PATH instructions
add_to_path() {
    echo ""

    # Check if already in PATH
    if [[ ":$PATH:" == *":$BIN_DIR:"* ]]; then
        echo -e "${GREEN}✓${NC} $BIN_DIR is already in your PATH"
    else
        echo -e "${CYAN}Add Substratia to your PATH:${NC}"
        echo ""

        SHELL_NAME=$(basename "$SHELL")
        case "$SHELL_NAME" in
            bash)
                echo "  echo 'export PATH=\"$BIN_DIR:\$PATH\"' >> ~/.bashrc"
                echo "  source ~/.bashrc"
                ;;
            zsh)
                echo "  echo 'export PATH=\"$BIN_DIR:\$PATH\"' >> ~/.zshrc"
                echo "  source ~/.zshrc"
                ;;
            fish)
                echo "  fish_add_path $BIN_DIR"
                ;;
            *)
                echo "  export PATH=\"$BIN_DIR:\$PATH\""
                ;;
        esac
        echo ""
    fi
}

# Main installation
main() {
    check_requirements
    detect_platform
    install_via_package_manager

    echo ""
    echo -e "${GREEN}Installation complete!${NC}"
    echo ""
    echo "Quick start:"
    echo "  substratia register \"your@email.com\"    # Get your API key"
    echo "  substratia learn \"Something important\"  # Store a memory"
    echo "  substratia remember \"query\"             # Search memories"
    echo "  substratia bridge                        # Full context restore"
    echo ""
    echo "Documentation: https://substratia.io/docs"
    echo ""
}

main "$@"
